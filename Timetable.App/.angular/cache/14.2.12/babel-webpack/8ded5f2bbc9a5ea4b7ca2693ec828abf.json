{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/MikolajMakowski/source/repos/Mik1mak/Timetable-A/Timetable.App/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { TotalTime } from '@app/_helpers';\nimport { Day } from '@app/_models';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@app/_services\";\nimport * as i2 from \"@angular/common\";\nimport * as i3 from \"../week/week.component\";\nimport * as i4 from \"../weeks-modal-add-lesson/weeks-modal-add-lesson.component\";\nfunction WeeksComponent_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 3)(1, \"div\", 4)(2, \"span\", 5);\n    i0.ɵɵtext(3, \"Loading...\");\n    i0.ɵɵelementEnd()()();\n  }\n}\nfunction WeeksComponent_div_2_app_week_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"app-week\", 8);\n  }\n  if (rf & 2) {\n    const week_r3 = ctx.$implicit;\n    i0.ɵɵproperty(\"week\", week_r3);\n  }\n}\nfunction WeeksComponent_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\")(1, \"div\", 6);\n    i0.ɵɵtemplate(2, WeeksComponent_div_2_app_week_2_Template, 1, 1, \"app-week\", 7);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r1.weeks);\n  }\n}\nexport class WeeksComponent {\n  constructor(timetableService, groupService, userService, toaster) {\n    this.timetableService = timetableService;\n    this.groupService = groupService;\n    this.userService = userService;\n    this.toaster = toaster;\n    this.loading = true;\n  }\n  ngOnInit() {\n    this.timetableService.get().subscribe({\n      next: t => {\n        this.loading = false;\n        this.weeks = t.weeks;\n        this.userService.currentUser.subscribe({\n          next: newUser => {\n            this.refillWeeks().then(() => {\n              this.refillDays();\n            });\n          }\n        });\n      },\n      error: err => {\n        this.loading = false;\n        this.toaster.add(err);\n      }\n    });\n  }\n  refillWeeks() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      for (let i = 1; i <= _this.userService.currentUserValue.cycles; i++) {\n        const week = _this.weeks[i - 1];\n        if (week) if (week.number == i) continue;\n        const newWeek = yield _this.timetableService.getWeek(i).toPromise();\n        _this.weeks.splice(i - 1, 0, newWeek);\n      }\n      _this.weeks.length = _this.userService.currentUserValue.cycles;\n    })();\n  }\n  refillDays() {\n    for (const week of this.weeks) {\n      for (let i = 1; i <= 7; i++) {\n        const element = week.days[i - 1];\n        if (element?.dayOfWeek != i) this.addEmptyDay(week, i);\n      }\n    }\n  }\n  addEmptyDay(week, dayNumber) {\n    const newDay = new Day();\n    newDay.dayOfWeek = dayNumber;\n    newDay.lessons = [];\n    week.days.splice(dayNumber - 1, 0, newDay);\n    return newDay;\n  }\n  addLesson(lessonAndWeekNum) {\n    const lesson = lessonAndWeekNum.lesson;\n    const weekIndex = lessonAndWeekNum.week - 1;\n    const week = this.weeks[weekIndex];\n    const dayIndex = (lesson.start.getDay() + 6) % 7;\n    const day = week.days[dayIndex];\n    if (day) {\n      day.lessons.push(lesson);\n      if (this.groupService.selectedValue.includes(lesson.groupId)) day.isVisible = true;\n    }\n    this.refreshWeekExtremes(week);\n    this.groupService.refreshSelectable();\n  }\n  refreshWeekExtremes(week) {\n    week.days.forEach(day => day.lessons.forEach(lesson => {\n      if (lesson.duration < week.minDuration) week.minDuration = lesson.duration;\n      let lessonStart = new Date(lesson.start);\n      if (TotalTime.minutesInDay(lessonStart) < TotalTime.minutesInDay(week.minStart)) week.minStart = lessonStart;\n      if (TotalTime.minutesInDay(lessonStart) + lesson.duration > TotalTime.minutesInDay(week.maxStop)) {\n        lessonStart.setMinutes(lessonStart.getMinutes() + lesson.duration);\n        week.maxStop = lessonStart;\n      }\n    }));\n  }\n}\nWeeksComponent.ɵfac = function WeeksComponent_Factory(t) {\n  return new (t || WeeksComponent)(i0.ɵɵdirectiveInject(i1.TimetableService), i0.ɵɵdirectiveInject(i1.GroupsService), i0.ɵɵdirectiveInject(i1.UserService), i0.ɵɵdirectiveInject(i1.ToasterService));\n};\nWeeksComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: WeeksComponent,\n  selectors: [[\"app-weeks\"]],\n  decls: 3,\n  vars: 2,\n  consts: [[3, \"saveEvent\"], [\"class\", \"text-center my-5\", 4, \"ngIf\"], [4, \"ngIf\"], [1, \"text-center\", \"my-5\"], [\"role\", \"status\", 1, \"spinner-border\"], [1, \"visually-hidden\"], [1, \"container-fluid\", \"p-0\", \"m-0\"], [3, \"week\", 4, \"ngFor\", \"ngForOf\"], [3, \"week\"]],\n  template: function WeeksComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"app-weeks-modal-add-lesson\", 0);\n      i0.ɵɵlistener(\"saveEvent\", function WeeksComponent_Template_app_weeks_modal_add_lesson_saveEvent_0_listener($event) {\n        return ctx.addLesson($event);\n      });\n      i0.ɵɵelementEnd();\n      i0.ɵɵtemplate(1, WeeksComponent_div_1_Template, 4, 0, \"div\", 1);\n      i0.ɵɵtemplate(2, WeeksComponent_div_2_Template, 3, 1, \"div\", 2);\n    }\n    if (rf & 2) {\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.loading);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", !ctx.loading && ctx.weeks);\n    }\n  },\n  dependencies: [i2.NgForOf, i2.NgIf, i3.WeekComponent, i4.WeeksModalAddLessonComponent],\n  styles: [\"\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsImZpbGUiOiJ3ZWVrcy5jb21wb25lbnQuY3NzIn0= */\"]\n});","map":{"version":3,"names":["TotalTime","Day","i0","ɵɵelementStart","ɵɵtext","ɵɵelementEnd","ɵɵelement","ɵɵproperty","week_r3","ɵɵtemplate","WeeksComponent_div_2_app_week_2_Template","ɵɵadvance","ctx_r1","weeks","WeeksComponent","constructor","timetableService","groupService","userService","toaster","loading","ngOnInit","get","subscribe","next","t","currentUser","newUser","refillWeeks","then","refillDays","error","err","add","_this","_asyncToGenerator","i","currentUserValue","cycles","week","number","newWeek","getWeek","toPromise","splice","length","element","days","dayOfWeek","addEmptyDay","dayNumber","newDay","lessons","addLesson","lessonAndWeekNum","lesson","weekIndex","dayIndex","start","getDay","day","push","selectedValue","includes","groupId","isVisible","refreshWeekExtremes","refreshSelectable","forEach","duration","minDuration","lessonStart","Date","minutesInDay","minStart","maxStop","setMinutes","getMinutes","ɵɵdirectiveInject","i1","TimetableService","GroupsService","UserService","ToasterService","selectors","decls","vars","consts","template","WeeksComponent_Template","rf","ctx","ɵɵlistener","WeeksComponent_Template_app_weeks_modal_add_lesson_saveEvent_0_listener","$event","WeeksComponent_div_1_Template","WeeksComponent_div_2_Template"],"sources":["C:\\Users\\MikolajMakowski\\source\\repos\\Mik1mak\\Timetable-A\\Timetable.App\\src\\app\\weeks\\weeks.component.ts","C:\\Users\\MikolajMakowski\\source\\repos\\Mik1mak\\Timetable-A\\Timetable.App\\src\\app\\weeks\\weeks.component.html"],"sourcesContent":["import { Component, OnInit } from '@angular/core';\r\nimport { TotalTime } from '@app/_helpers';\r\nimport { Day, Lesson, Week } from '@app/_models';\r\nimport { GroupsService, TimetableService, ToasterService, UserService } from '@app/_services';\r\n\r\n@Component({\r\n  selector: 'app-weeks',\r\n  templateUrl: './weeks.component.html',\r\n  styleUrls: ['./weeks.component.css']\r\n})\r\nexport class WeeksComponent implements OnInit {\r\n\r\n  weeks?: Week[];\r\n  loading = true;\r\n\r\n  constructor(\r\n    private timetableService: TimetableService,\r\n    private groupService: GroupsService,\r\n    private userService: UserService,\r\n    private toaster: ToasterService) { }\r\n\r\n  ngOnInit(): void {\r\n    this.timetableService.get().subscribe({\r\n      next: t => {\r\n        this.loading = false;\r\n        this.weeks = t.weeks;\r\n\r\n        this.userService.currentUser.subscribe({\r\n          next: newUser => {\r\n            this.refillWeeks().then(() =>{\r\n              this.refillDays();\r\n            });          \r\n          }\r\n        });\r\n      },\r\n      error: err => {   \r\n        this.loading = false;\r\n        this.toaster.add(err);\r\n      }\r\n    });\r\n  }\r\n\r\n  private async refillWeeks() {\r\n    for (let i = 1; i <= this.userService.currentUserValue.cycles!; i++) {\r\n      const week = this.weeks![i-1];\r\n      \r\n      if(week)\r\n        if(week.number == i)\r\n          continue;\r\n\r\n      const newWeek = await this.timetableService.getWeek(i).toPromise();\r\n      this.weeks!.splice(i-1, 0, newWeek);\r\n    }\r\n\r\n    this.weeks!.length = this.userService.currentUserValue.cycles!;\r\n  }\r\n\r\n  private refillDays() {\r\n    for (const week of this.weeks!) {\r\n      for (let i = 1; i <= 7; i++) {\r\n        const element = week.days![i-1];\r\n        if(element?.dayOfWeek != i) \r\n          this.addEmptyDay(week, i);\r\n      } \r\n    }\r\n  }\r\n\r\n  private addEmptyDay(week: Week, dayNumber: number): Day {\r\n    const newDay = new Day();\r\n    newDay.dayOfWeek = dayNumber;\r\n    newDay.lessons = [];\r\n    week.days!.splice(dayNumber-1, 0, newDay);\r\n    return newDay;\r\n  }\r\n\r\n  addLesson(lessonAndWeekNum: any) {\r\n    const lesson: Lesson = lessonAndWeekNum.lesson;\r\n    const weekIndex = lessonAndWeekNum.week - 1;\r\n\r\n    const week = this.weeks![weekIndex];\r\n    const dayIndex = (lesson.start.getDay()+6) % 7;\r\n    const day = week.days![dayIndex];\r\n\r\n    if(day) {\r\n      day.lessons.push(lesson);\r\n      if(this.groupService.selectedValue.includes(lesson.groupId))\r\n        day.isVisible = true;\r\n    }\r\n\r\n    this.refreshWeekExtremes(week);\r\n    this.groupService.refreshSelectable();\r\n  }\r\n\r\n  private refreshWeekExtremes(week: Week) {\r\n    week.days!.forEach(day => day.lessons.forEach(lesson => {\r\n      if(lesson.duration < week.minDuration!)\r\n      week.minDuration = lesson.duration;\r\n\r\n      let lessonStart = new Date(lesson.start);\r\n\r\n      if(TotalTime.minutesInDay(lessonStart) < TotalTime.minutesInDay(week.minStart!))\r\n        week.minStart = lessonStart;\r\n\r\n      if(TotalTime.minutesInDay(lessonStart)+lesson.duration > TotalTime.minutesInDay(week.maxStop!))\r\n      {\r\n        lessonStart.setMinutes(lessonStart.getMinutes() + lesson.duration);\r\n        week.maxStop = lessonStart;\r\n      }\r\n    }))\r\n  }\r\n\r\n}\r\n","<app-weeks-modal-add-lesson (saveEvent)=\"addLesson($event)\"></app-weeks-modal-add-lesson>\r\n<div class=\"text-center my-5\" *ngIf=\"loading\">\r\n    <div class=\"spinner-border\" role=\"status\">\r\n        <span class=\"visually-hidden\">Loading...</span>\r\n    </div>\r\n</div>\r\n<div *ngIf=\"!loading && weeks\">\r\n    <div class=\"container-fluid p-0 m-0\">\r\n        <app-week *ngFor=\"let week of weeks\" [week]=\"week\"></app-week>\r\n    </div>\r\n</div>"],"mappings":"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"},"metadata":{},"sourceType":"module"}